

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>U-Net training &mdash; Microscopy Nuclei 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=2709fde1"></script>
      <script src="_static/doctools.js?v=888ff710"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="HoVer-Net training" href="Train_HoVerNet.html" />
    <link rel="prev" title="Preprocessing" href="Preprcoessing.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Microscopy Nuclei
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Steps:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Environment.html">Conda Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="Environment.html#apptainer-container">Apptainer container</a></li>
<li class="toctree-l1"><a class="reference internal" href="Preprcoessing.html">Preprocessing</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">U-Net training</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#annotation">Annotation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cvat">cvat</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#published-datasets">Published Datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="#preprcoessing">Preprcoessing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#training">Training</a></li>
<li class="toctree-l2"><a class="reference internal" href="#prediction">Prediction</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Train_HoVerNet.html">HoVer-Net training</a></li>
<li class="toctree-l1"><a class="reference internal" href="Evaluation.html">Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Pipeline.html">Full pipeline</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Microscopy Nuclei</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">U-Net training</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/Train_UNet.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="u-net-training">
<h1>U-Net training<a class="headerlink" href="#u-net-training" title="Link to this heading"></a></h1>
<p>For training U-Net models, the code is taken and modified from <a class="reference external" href="https://github.com/carpenterlab/unet4nuclei/tree/master/unet4nuclei">carpenterLab</a>.</p>
<section id="annotation">
<h2>Annotation<a class="headerlink" href="#annotation" title="Link to this heading"></a></h2>
<p>For training UNet models, some images are taken from <a class="reference external" href="https://bbbc.broadinstitute.org/">Broadinstitute</a> as well as annotated masks for similarity of these images to
Our own images. However, we had to annotate more of our own images and combine them with online available images.
For this purpose, we have used cvat tool.</p>
<section id="cvat">
<h3>cvat<a class="headerlink" href="#cvat" title="Link to this heading"></a></h3>
<p>How we used:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/opencv/cvat
<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>cvat
</pre></div>
</div>
<p>Run docker containers. It will take some time to download the latest CVAT release and other required images like postgres, redis, etc. from DockerHub and create containers.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="w"> </span>docker<span class="w"> </span>compose<span class="w"> </span>up<span class="w"> </span>-d
</pre></div>
</div>
<p>(Optional) Use CVAT_VERSION environment variable to specify the version of CVAT you want to install specific version (e.g v2.1.0, dev). Default behavior: dev images will be pulled for develop branch, and corresponding release images for release versions.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">CVAT_VERSION</span><span class="o">=</span>dev<span class="w"> </span>docker<span class="w"> </span>compose<span class="w"> </span>up<span class="w"> </span>-d
</pre></div>
</div>
<p>Alternative: if you want to build the images locally with unreleased changes see How to pull/build/update CVAT images section
You can register a user but by default, it will not have rights even to view the list of tasks. Thus you should create a superuser. A superuser can use an admin panel to assign correct groups to other users. Please use the command below:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>cvat_server<span class="w"> </span>bash<span class="w"> </span>-ic<span class="w"> </span><span class="s1">&#39;python3 ~/manage.py createsuperuser&#39;</span>
</pre></div>
</div>
<p>If you don’t have winpty installed or the above command does not work, you may also try the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># enter docker image first</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>cvat_server<span class="w"> </span>/bin/bash
<span class="c1"># then run</span>
python3<span class="w"> </span>~/manage.py<span class="w"> </span>createsuperuser
</pre></div>
</div>
<p>Choose a username and a password for your admin account.
Open the installed Google Chrome browser and go to localhost:8080.
Type your login/password for the superuser on the login page and press the Login button. Now you should be able to create a new annotation task.</p>
<p>I also had to download docker desktop. Now I only open that and run cvat container on that.
Then open localhost:8080 on my browser. In cvat also I can define projects and labels.
Then add a job and start to annotate. Annotations are polygons and not polyline.</p>
</section>
</section>
<section id="published-datasets">
<h2>Published Datasets<a class="headerlink" href="#published-datasets" title="Link to this heading"></a></h2>
<p>The annotated datasets are published.</p>
<p><a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S2352340922009726">Nuclei</a></p>
<p><a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S2352340924011107">Cytosol</a></p>
</section>
<section id="preprcoessing">
<h2>Preprcoessing<a class="headerlink" href="#preprcoessing" title="Link to this heading"></a></h2>
<p>After exporting annotation masks from cvat, train/UNet/preprocessing.py script will run over masks to create boundary images.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3<span class="w"> </span>preprocessing.py
</pre></div>
</div>
<p>example of raw annotated image</p>
<p><img alt="annotated" src="_images/annot.png" /></p>
<p>Three class (background, inside and boundary pcs) images are as follows:</p>
<p><img alt="boundary" src="_images/class.png" /></p>
</section>
<section id="training">
<h2>Training<a class="headerlink" href="#training" title="Link to this heading"></a></h2>
<p>After having directories in the following order:</p>
<div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>UNet/
├── data
│   ├── 0_raw_images
│   ├── 1_raw_annotations
│   ├── 2_norm_images
│   ├── 2_norm_images_merged
│   ├── 3_boundary_labels
│   └── 4_filelists
│       ├── TEST.txt
│       ├── training.txt
│       └── VALIDATION
├── src
│   ├── utils
│   ├── preprocessing.py
│   ├── training.py
│   ├── prediction.py
│   ├── evaluation.ipynb
│   ├──experiments
│       ├── experiment_name
│       │   ├── models
│       │   │   ├── model_xxx.hdf5
│       │   ├── log.csv
│       │   ├── model.hdf5
│   └── experiment_name
│       ├── out
│       │   │   ├── prob
│       │   │   └── segm

</pre></div>
</div>
<p>we trained models with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3<span class="w"> </span>training.py
</pre></div>
</div>
</section>
<section id="prediction">
<h2>Prediction<a class="headerlink" href="#prediction" title="Link to this heading"></a></h2>
<p>we predicted the segmentation masks of validation and test images with the best model:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3<span class="w"> </span>prediction.py
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Preprcoessing.html" class="btn btn-neutral float-left" title="Preprocessing" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Train_HoVerNet.html" class="btn btn-neutral float-right" title="HoVer-Net training" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>